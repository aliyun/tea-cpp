name: C++ CI

permissions:
  contents: read

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    name: ${{ matrix.os }} - C++${{ matrix.cxx_standard }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        cxx_standard: [11, 14, 17, 20]
        # Restrict combinations to save time
        exclude:
          - os: macos-latest
            cxx_standard: 14
          - os: macos-latest
            cxx_standard: 17
          - os: macos-latest
            cxx_standard: 20
          - os: windows-latest
            cxx_standard: 14
          - os: windows-latest
            cxx_standard: 17
          - os: windows-latest
            cxx_standard: 20

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        # Install GCC 13 for better C++ standard compliance
        sudo apt-get install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        # Install dependencies
        sudo apt-get install -y libssl-dev uuid-dev zlib1g-dev
        # Install dynamic libcurl for shared builds
        sudo apt-get install -y libcurl4-openssl-dev
        
    - name: Build minimal static libcurl (Linux)
      if: runner.os == 'Linux'
      run: |
        # Build a minimal libcurl with only HTTPS support for static linking
        curl -L https://curl.se/download/curl-8.5.0.tar.gz -o curl.tar.gz
        tar -xzf curl.tar.gz
        cd curl-8.5.0
        ./configure --prefix=/usr/local/curl-minimal \
          --disable-shared --enable-static \
          --with-openssl \
          --without-libpsl --without-nghttp2 --without-libssh2 --without-libssh \
          --without-gssapi --without-libidn2 --without-librtmp --without-zstd \
          --without-brotli --without-zlib \
          --disable-ldap --disable-ldaps --disable-rtsp --disable-dict \
          --disable-telnet --disable-tftp --disable-pop3 --disable-imap \
          --disable-smb --disable-smtp --disable-gopher --disable-mqtt \
          --disable-manual --disable-docs --disable-unix-sockets
        make -j$(nproc)
        sudo make install

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install openssl curl
        echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl)" >> $GITHUB_ENV

    - name: Cache vcpkg packages (Windows)
      if: runner.os == 'Windows'
      uses: actions/cache@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/packages
          C:/vcpkg/buildtrees
          C:/vcpkg/downloads
          ~/AppData/Local/vcpkg/archives
        # Key based on fixed dependencies: curl + openssl
        # Change this key if you modify vcpkg dependencies
        key: ${{ runner.os }}-vcpkg-curl-openssl-v1-${{ matrix.cxx_standard }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-curl-openssl-v1-
          ${{ runner.os }}-vcpkg-

    - name: Setup vcpkg binary cache (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        # Enable vcpkg binary caching to GitHub Actions cache
        export VCPKG_BINARY_SOURCES="clear;x-gha,readwrite"
        echo "VCPKG_BINARY_SOURCES=$VCPKG_BINARY_SOURCES" >> $GITHUB_ENV

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        # Use parallel build and binary caching
        export VCPKG_MAX_CONCURRENCY=$NUMBER_OF_PROCESSORS
        vcpkg install curl:x64-windows openssl:x64-windows --no-print-usage

    # Build and test both shared and static libraries in one job
    - name: Build Shared Library
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -B build-shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install-shared \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -B build-shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install-shared
        fi
        cmake --build build-shared --config Release

    - name: Test Shared Library
      shell: bash
      timeout-minutes: 5
      run: |
        cd build-shared
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows: Copy DLL to test directory and run directly
          cp src/Release/*.dll tests/Release/ 2>/dev/null || true
          ./tests/Release/darabonba_coreTest.exe
        else
          ctest --output-on-failure -C Release
        fi

    - name: Install Shared Library
      run: cmake --install build-shared --config Release --prefix ./install-shared

    - name: Test find_package Integration (Shared)
      shell: bash
      run: |
        mkdir -p sample_test_shared
        cat > sample_test_shared/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.13)
        project(sample_test CXX)
        find_package(darabonba_core REQUIRED)
        add_executable(sample_app main.cpp)
        target_link_libraries(sample_app darabonba_core::darabonba_core)
        EOF
        echo "int main() { return 0; }" > sample_test_shared/main.cpp
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -S sample_test_shared -B sample_test_shared/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-shared \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -S sample_test_shared -B sample_test_shared/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-shared \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }}
        fi
        cmake --build sample_test_shared/build --config Release

    - name: Build Static Library
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -B build-static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install-static \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        elif [ "${{ runner.os }}" = "Linux" ]; then
          # Use minimal static libcurl for Linux static builds
          cmake -B build-static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install-static \
            -DCURL_ROOT=/usr/local/curl-minimal \
            -DCURL_LIBRARY=/usr/local/curl-minimal/lib/libcurl.a \
            -DCURL_INCLUDE_DIR=/usr/local/curl-minimal/include
        else
          cmake -B build-static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install-static
        fi
        cmake --build build-static --config Release

    - name: Test Static Library
      shell: bash
      timeout-minutes: 5
      run: |
        cd build-static
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows: Run test directly
          ./tests/Release/darabonba_coreTest.exe
        else
          ctest --output-on-failure -C Release
        fi

    - name: Install Static Library
      run: cmake --install build-static --config Release --prefix ./install-static

    - name: Test find_package Integration (Static)
      shell: bash
      run: |
        mkdir -p sample_test_static
        cat > sample_test_static/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.13)
        project(sample_test CXX)
        find_package(darabonba_core REQUIRED)
        add_executable(sample_app main.cpp)
        target_link_libraries(sample_app darabonba_core::darabonba_core)
        EOF
        echo "int main() { return 0; }" > sample_test_static/main.cpp
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -S sample_test_static -B sample_test_static/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-static \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        elif [ "${{ runner.os }}" = "Linux" ]; then
          cmake -S sample_test_static -B sample_test_static/build \
            -DCMAKE_PREFIX_PATH="$(pwd)/install-static;/usr/local/curl-minimal"
        else
          cmake -S sample_test_static -B sample_test_static/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-static \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }}
        fi
        cmake --build sample_test_static/build --config Release
