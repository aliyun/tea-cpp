name: C++ CI

permissions:
  contents: read

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    name: ${{ matrix.os }} - ${{ matrix.lib_type }} - C++${{ matrix.cxx_standard }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        lib_type: [shared, static]
        cxx_standard: [11, 14, 17]
        # Restrict combinations to save time
        exclude:
          - os: macos-latest
            cxx_standard: 14
          - os: macos-latest
            cxx_standard: 17
          - os: windows-latest
            cxx_standard: 14
          - os: windows-latest
            cxx_standard: 17

    steps:
    - uses: actions/checkout@v4

    - name: Format Check
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update && sudo apt-get install -y clang-format
        find src include tests -name '*.hpp' -o -name '*.cpp' | xargs clang-format --dry-run --Werror || echo "Format check failed"

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev uuid-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install openssl curl
        echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl)" >> $GITHUB_ENV

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        vcpkg install curl:x64-windows openssl:x64-windows

    - name: Cache vcpkg packages (Windows)
      if: runner.os == 'Windows'
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_INSTALLATION_ROOT }}/installed
        key: ${{ runner.os }}-vcpkg-${{ matrix.cxx_standard }}-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-${{ matrix.cxx_standard }}-
          ${{ runner.os }}-vcpkg-

    - name: Configure CMake
      shell: bash
      run: |
        LIB_SHARED=OFF
        if [ "${{ matrix.lib_type }}" = "shared" ]; then LIB_SHARED=ON; fi
        
        # Windows needs toolchain file
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=$LIB_SHARED \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=$LIB_SHARED \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DENABLE_UNIT_TESTS=ON \
            -DCMAKE_INSTALL_PREFIX=./install
        fi

    - name: Build
      run: cmake --build build --config Release

    - name: Test
      shell: bash
      timeout-minutes: 10
      run: |
        cd build
        ctest --output-on-failure -C Release --timeout 300

    - name: Install
      run: cmake --install build --config Release --prefix ./install

    - name: Test find_package Integration
      shell: bash
      run: |
        mkdir -p sample_test
        cat > sample_test/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.13)
        project(sample_test CXX)
        find_package(darabonba_core REQUIRED)
        add_executable(sample_app main.cpp)
        target_link_libraries(sample_app darabonba_core::darabonba_core)
        EOF
        echo "int main() { return 0; }" > sample_test/main.cpp
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -S sample_test -B sample_test/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -S sample_test -B sample_test/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }}
        fi
